#!/bin/bash
LOG_FILE="$HOME/metrics-tracker/notify_prod.log"
LAST_RUN_FILE="$Hosascript -e 'display notification "â° Time to log your metrics!" with title "ðŸ“Š Metrics Tracker" sound name "Glass"'
echo "[$(date)] âœ… Notification sent" >> "$LOG_FILE"

sleep 1

# Check if Streamlit is running
if curl -s http://localhost:8501 > /dev/null 2>&1; then
    echo "[$(date)] âœ… Streamlit running, opening browser" >> "$LOG_FILE"
    open "http://localhost:8501"
    echo "[$(date)] âœ… Browser opened" >> "$LOG_FILE"
else
    echo "[$(date)] âš ï¸  Streamlit not running, attempting to start..." >> "$LOG_FILE"
    cd "$HOME/metrics-tracker"
    export PATH="$HOME/.local/bin:$PATH"
    nohup uv run streamlit run metrics_app.py > /tmp/metrics_streamlit.log 2>&1 &
    sleep 5
    
    if curl -s http://localhost:8501 > /dev/null 2>&1; then
        echo "[$(date)] âœ… Streamlit started successfully" >> "$LOG_FILE"
        open "http://localhost:8501"
    else
        echo "[$(date)] âŒ Failed to start Streamlit" >> "$LOG_FILE"
        osascript -e 'display notification "Failed to start Streamlit!" with title "âŒ Error" sound name "Basso"'
    fi
fi

echo "$CURRENT_DATE" > "$LAST_RUN_FILE"
echo "$CURRENT_TIME" > "$LAST_RUN_FILE.time"
echo "[$(date)] âœ… Recorded run for $CURRENT_DATE at $CURRENT_TIME" >> "$LOG_FILE"ker/.last_prod_run"
PLIST_FILE="$HOME/Library/LaunchAgents/com.metricsTracker.prod.plist"

echo "[$(date)] ========================================" >> "$LOG_FILE"
echo "[$(date)] ðŸš€ PROD - smart_notify.sh started" >> "$LOG_FILE"

CURRENT_DATE=$(date +%Y-%m-%d)
CURRENT_TIME=$(date '+%H:%M')
CURRENT_DAY=$(date +%u)
CURRENT_HOUR=$(date +%H)
CURRENT_MINUTE=$(date +%M)
CURRENT_MINS=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MINUTE))

echo "[$(date)] Current: $(date +%A) ($CURRENT_DAY), Time=$CURRENT_TIME" >> "$LOG_FILE"

# Check if we already ran today
if [ -f "$LAST_RUN_FILE" ]; then
    LAST_RUN_DATE=$(cat "$LAST_RUN_FILE")
    LAST_RUN_TIME=$(cat "$LAST_RUN_FILE.time" 2>/dev/null || echo "00:00")
    echo "[$(date)] Last run was: $LAST_RUN_DATE at $LAST_RUN_TIME" >> "$LOG_FILE"
    
    if [ "$LAST_RUN_DATE" == "$CURRENT_DATE" ]; then
        echo "[$(date)] âš ï¸  Already ran today. Skipping." >> "$LOG_FILE"
        exit 0
    fi
fi

# Read schedule from plist
if [ ! -f "$PLIST_FILE" ]; then
    echo "[$(date)] âŒ Plist file not found: $PLIST_FILE" >> "$LOG_FILE"
    exit 1
fi

# Check if today is a scheduled day and if we're past the scheduled time
SHOULD_RUN=false
GRACE_PERIOD_MINS=60  # 1 hour grace period for missed schedules

# Extract all calendar intervals from plist
plutil -convert json -o /tmp/metrics_schedule.json "$PLIST_FILE"
SCHEDULE_COUNT=$(python3 -c "import json; data=json.load(open('/tmp/metrics_schedule.json')); print(len(data.get('StartCalendarInterval', [])))")

for i in $(seq 0 $((SCHEDULE_COUNT - 1))); do
    SCHED_DAY=$(python3 -c "import json; data=json.load(open('/tmp/metrics_schedule.json')); print(data['StartCalendarInterval'][$i]['Weekday'])")
    SCHED_HOUR=$(python3 -c "import json; data=json.load(open('/tmp/metrics_schedule.json')); print(data['StartCalendarInterval'][$i]['Hour'])")
    SCHED_MIN=$(python3 -c "import json; data=json.load(open('/tmp/metrics_schedule.json')); print(data['StartCalendarInterval'][$i]['Minute'])")
    SCHED_MINS=$((SCHED_HOUR * 60 + SCHED_MIN))
    
    echo "[$(date)] Checking schedule: Weekday=$SCHED_DAY, Time=$SCHED_HOUR:$(printf '%02d' $SCHED_MIN)" >> "$LOG_FILE"
    
    if [ "$CURRENT_DAY" -eq "$SCHED_DAY" ]; then
        echo "[$(date)] âœ… Today matches scheduled weekday ($SCHED_DAY)" >> "$LOG_FILE"
        
        # Check if we're within the time window (scheduled time to scheduled time + grace period)
        TIME_DIFF=$((CURRENT_MINS - SCHED_MINS))
        
        if [ $TIME_DIFF -ge 0 ] && [ $TIME_DIFF -le $GRACE_PERIOD_MINS ]; then
            echo "[$(date)] âœ… Within time window: $TIME_DIFF mins after scheduled time (grace: $GRACE_PERIOD_MINS mins)" >> "$LOG_FILE"
            SHOULD_RUN=true
            break
        elif [ $TIME_DIFF -lt 0 ]; then
            echo "[$(date)] â° Not yet time. Scheduled: $SCHED_HOUR:$(printf '%02d' $SCHED_MIN), Current: $CURRENT_TIME" >> "$LOG_FILE"
        else
            echo "[$(date)] â­ï¸  Too late. $TIME_DIFF mins after scheduled time (grace period expired)" >> "$LOG_FILE"
        fi
    fi
done

rm -f /tmp/metrics_schedule.json

if [ "$SHOULD_RUN" != "true" ]; then
    echo "[$(date)] â­ï¸  Not scheduled for now â†’ SKIPPING" >> "$LOG_FILE"
    exit 0
fi

echo "[$(date)] âœ… Running metrics notification" >> "$LOG_FILE"

osascript -e 'display notification "â° SLEEP TEST: Woke up after scheduled time!" with title "ðŸ“Š Metrics Tracker TEST" sound name "Glass"'
echo "[$(date)] âœ… Notification sent" >> "$LOG_FILE"

sleep 1

if curl -s http://localhost:8501 > /dev/null 2>&1; then
    echo "[$(date)] âœ… Streamlit running, opening browser" >> "$LOG_FILE"
    open "http://localhost:8501"
    echo "[$(date)] âœ… Browser opened" >> "$LOG_FILE"
else
    echo "[$(date)] âš ï¸  Streamlit not running" >> "$LOG_FILE"
    osascript -e 'display notification "Streamlit not running!" with title "âŒ Error" sound name "Basso"'
fi

echo "$CURRENT_DATE" > "$LAST_RUN_FILE"
echo "[$(date)] âœ… Recorded run" >> "$LOG_FILE"
